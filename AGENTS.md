# Vivliostyle CLI サーバーエージェント ノート

## 背景
- GROWI プラグインからのリクエストを受け取り、Vivliostyle CLI を実行して公開用成果物（デフォルトは PDF）を生成する HTTP サービスを提供する。
- 各ジョブをサンドボックス化し、決定的な出力管理とダウンロード可能な成果物提供を保証する。

## 実装方針
- サーバーは Node.js（TypeScript）で実装し、HTTP レイヤーは Express を利用する。
- Vivliostyle 実行は制御されたジョブキューで管理し、ホスト負荷を抑える。
- 各ジョブは `jobs/<jobId>` 配下の作業領域で実行し、入力アーカイブの展開、CLI 実行、ログと出力の収集を行う。
- ポート、同時実行数、作業ディレクトリ、CLI タイムアウトなどは環境変数で設定できるようにし、妥当なデフォルト値を用意する。
- ジョブのメタデータはジョブディレクトリ内の JSON として保存し、再起動や事後調査に備える。
- 実行ログは JSON Lines 形式で公開し、CLI の標準出力／標準エラーをジョブ詳細レスポンスに含める。

## API 概要
- `POST /api/v1/jobs`
  - ボディ: `{ jobId?, sourceArchive (base64 zip), cliOptions { config?, entry?, output?, format? }, metadata {...} }`
  - レスポンス: `{ jobId, status, createdAt }`
  - `jobId` が省略された場合はサーバー側で UUID を発行。
- `GET /api/v1/jobs/:jobId`
  - タイムスタンプ、CLI 終了コード、直近ログなどを含むステータスを返す。
- `GET /api/v1/jobs/:jobId/result`
  - 生成された成果物（デフォルトは PDF）をストリームで返す。`?file=` で出力内の任意ファイルを指定可能。
- `GET /api/v1/jobs/:jobId/log`
  - CLI の統合ログをストリームで返し、クライアントからの閲覧を容易にする。
- `DELETE /api/v1/jobs/:jobId`
  - GROWI プラグインからの削除シグナルに応じてジョブ一式（成果物を含む）を削除する。`running`/`queued` のジョブには 409 を返す。

## ジョブライフサイクル
1. リクエストボディを検証し保存する。設定上限を超えるアーカイブは拒否する。
2. アーカイブを作業領域に展開し、メタデータファイルを出力してジョブをキューに積む。
3. ワーカーが `VIV_QUEUE_CONCURRENCY`（デフォルト 1）の制約を守りながらジョブを取り出す。
4. 作業ディレクトリを `cwd` として `node_modules/.bin/vivliostyle build` を指定オプション付きで実行する。
5. 生成された成果物（PDF や ZIP）は `jobs/<jobId>/output` に収集する。
6. ジョブステータスを更新し、ダウンロード可能にする。将来的には保存期間に応じたクリーンアップを検討する。

## 残課題
- 任意の Webhook コールバック URL サポートを追加（将来対応）。
- API エンドポイントの認証／認可を検討（初期スコープ外）。
- 保存期限に応じたクリーンアップ処理（cron 等）の実装は範囲外のため、運用手順を文書化する。
- フロントが ATTACHMENT へ成果物を移送後に削除リクエストを必ず送る運用を GROWI プラグイン側に明記する。

#!/usr/bin/env bash
set -euo pipefail

# update: complete overwrite deploy for this repository
# - detects PM2 processes running from this repo and stops/deletes them
# - fetches origin/master, hard-resets and cleans
# - installs production deps, builds, starts via pm2.config.cjs
# - runs npx pm2 startup and attempts to apply the printed command if possible

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

echo "Snapshotting disabled by request; proceeding without saving snapshots."

# Attempt to stop/delete well-known PM2 apps for this project
echo "Stopping known PM2 apps (if present)..."
KNOWN_APPS="vivliostyle-proxy vivliostyle-cli-server"
for app in $KNOWN_APPS; do
  echo "Stopping $app (if exists)..."
  npx pm2 stop "$app" || true
  echo "Deleting $app (if exists)..."
  npx pm2 delete "$app" || true
done

echo "Attempting to discover PM2 processes by listing pm2 jlist (best-effort)..."
if npx pm2 jlist --silent >/dev/null 2>&1; then
  npx pm2 jlist --silent | node -e '
const fs=require("fs");
try{
  const data=fs.readFileSync(0,"utf8");
  const list=JSON.parse(data||"[]");
  const repo=process.argv[1];
  const repoPath=process.argv[1] || "";
  const procs = list.filter(p=>{
    const env = p.pm2_env || {};
    const cwd = env.pm_cwd || "";
    const exec = env.pm_exec_path || "";
    try{ if(cwd && cwd.indexOf(repoPath)!==-1) return true; }catch(e){}
    try{ if(exec && exec.indexOf(repoPath)!==-1) return true; }catch(e){}
    return false;
  }).map(p=>p.name||p.pm_id||"").filter(Boolean);
  if(procs.length>0){
    console.log("Found via jlist:", procs.join(' '));
    procs.forEach(function(name){
      try{ require('child_process').execSync('npx pm2 stop '+name); }catch(e){}
      try{ require('child_process').execSync('npx pm2 delete '+name); }catch(e){}
    });
  } else { console.log('No additional pm2 processes detected via jlist'); }
}catch(e){ console.error('pm2 jlist parse failed', e && e.message); }
' "$REPO_ROOT" || true
fi

echo "Fetching remote and hard-reset to origin/master..."
git fetch origin --prune
git reset --hard origin/master
git clean -fdx

echo "Installing dependencies for build (npm ci)"
# install all deps so build tools (devDependencies like rimraf) are present
npm ci

# After successful build we'll prune dev deps to keep production footprint small

if [ -f "$REPO_ROOT/package.json" ]; then
  if grep -q '"build"\s*:' package.json >/dev/null 2>&1; then
    echo "Running npm run build"
    npm run build
  else
    echo "No build script found in package.json; skipping build"
  fi
fi

# After build, remove devDependencies to keep production footprint small
echo "Pruning devDependencies (npm prune --production)"
npm prune --production || true

# Start via pm2.config.cjs if present
if [ -f "$REPO_ROOT/pm2.config.cjs" ]; then
  echo "Starting processes from pm2.config.cjs"
  npx pm2 start pm2.config.cjs --update-env --env production || true
  npx pm2 save || true
else
  echo "pm2.config.cjs not found; nothing started. If you want to start manually, run: npx pm2 start <script>"
fi

echo "Running 'npx pm2 startup' to generate startup command..."
STARTUP_OUTPUT=$(npx pm2 startup 2>&1 || true)
echo "$STARTUP_OUTPUT"

# Try to extract and run the suggested command (careful: may require sudo)
# Look for lines starting with sudo or containing systemctl enable
SUGGESTED_CMD=$(printf "%s" "$STARTUP_OUTPUT" | sed -n -E 's|^\s*(sudo .*|systemctl .*|/bin/.*pm2.*|pm2-startup-.*)$|\1|p' | head -n 1 || true)
if [ -n "$SUGGESTED_CMD" ]; then
  echo "Detected startup command: $SUGGESTED_CMD"
  if command -v sudo >/dev/null 2>&1; then
    echo "Attempting to run startup command with sudo (you may be prompted for your password)"
    eval "$SUGGESTED_CMD" || echo "Running the startup command failed; please run it manually."
    echo "Running 'npx pm2 save' after startup setup"
    npx pm2 save || true
  else
    echo "sudo not available; please run the following as root:" 
    echo "$SUGGESTED_CMD"
  fi
else
  echo "No explicit startup command detected in output. If your platform needs manual steps, run: npx pm2 startup" 
fi

echo "Deploy completed."

echo "Quick smoke checks (if curl available):"
if command -v curl >/dev/null 2>&1; then
  echo -n "Proxy root (http://127.0.0.1:4871/) -> "
  curl -fsS -o /dev/null -w "%{http_code}\n" http://127.0.0.1:4871/ || echo "FAILED"
  echo -n "API health (http://127.0.0.1:4781/healthz) -> "
  curl -fsS -o /dev/null -w "%{http_code}\n" http://127.0.0.1:4781/healthz || echo "FAILED"
else
  echo "curl not found; please perform manual smoke checks."
fi

exit 0
